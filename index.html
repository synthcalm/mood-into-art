<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mood Into Art</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background-color: black;
      color: #39ff14;
      font-family: 'Courier New', Courier, monospace;
      margin: 0;
      padding: 0;
    }
    .container {
      padding: 20px;
    }
    textarea, select, button {
      background-color: #000;
      border: 1px solid #39ff14;
      color: #39ff14;
      font-family: 'Courier New', Courier, monospace;
      font-size: 16px;
      padding: 10px;
      margin: 10px 0;
      width: 100%;
    }
    .canvas-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .canvas-grid canvas {
      width: 100%;
      height: 200px;
      background-color: #111;
      border: 1px solid #39ff14;
    }
    .scope {
      width: 100%;
      height: 50px;
      background-color: #111;
      margin-bottom: 10px;
    }
    #countdown {
      font-size: 24px;
      text-align: center;
      margin: 10px 0;
    }
    #transcribingIndicator {
      display: none;
      color: #ff4081;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mood Into Art 🎨</h1>

    <div class="scope" id="micScope">🎤 Scope Visual</div>

    <div id="countdown">Countdown: <span id="timer">0</span></div>

    <textarea id="activityInput" placeholder="Describe your mood..."></textarea>

    <button id="startVoice">🎙 Start Voice</button>
    <div id="transcribingIndicator">🧠 Listening...</div>

    <select id="styleSelect">
      <option value="cyberpunk">Cyberpunk</option>
      <option value="fantasy">Fantasy</option>
      <option value="realistic">Realistic</option>
    </select>

    <button id="generateImage">🖼 Generate Art</button>

    <div class="canvas-grid">
      <canvas id="canvas1"></canvas>
      <canvas id="canvas2"></canvas>
      <canvas id="canvas3"></canvas>
    </div>

    <audio id="beepSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
    <audio id="chimeSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
    <audio id="saveSound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
  </div>

  <script>
    const activityInput = document.getElementById('activityInput');
    const transcribingIndicator = document.getElementById('transcribingIndicator');
    const startVoiceButton = document.getElementById('startVoice');
    const micScope = document.getElementById('micScope');

    let socket, audioContext, mediaStream, workletNode;
    let isRecording = false;

    async function unlockAudioContextAndMic() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') await audioContext.resume();
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        return true;
      } catch (e) {
        alert("Microphone access failed: " + e.message);
        return false;
      }
    }

    async function startRecording() {
      try {
        const response = await fetch("https://mood-into-art-backend.onrender.com/assemblyai-token");
        const { token } = await response.json();

        socket = new WebSocket(`wss://api.assemblyai.com/v2/realtime/ws?sample_rate=16000&token=${token}`);

        socket.onmessage = (msg) => {
          const data = JSON.parse(msg.data);
          console.log("📥 AssemblyAI message:", data);
          if (data.text) {
            activityInput.value = data.text;
          }
        };

        socket.onopen = async () => {
          transcribingIndicator.style.display = 'block';
          micScope.textContent = "🎧 Mic Active...";

          await audioContext.audioWorklet.addModule(URL.createObjectURL(new Blob([`
            class AudioProcessor extends AudioWorkletProcessor {
              constructor() { super(); }
              process(inputs) {
                const input = inputs[0]?.[0];
                if (input?.length > 0) {
                  const downsampled = downsampleBuffer(input, sampleRate, 16000);
                  const int16 = floatTo16BitPCM(downsampled);
                  this.port.postMessage(int16);
                }
                return true;
              }
            }
            function floatTo16BitPCM(input) {
              const len = input.length;
              const result = new Int16Array(len);
              for (let i = 0; i < len; i++) {
                result[i] = Math.max(-1, Math.min(1, input[i])) * 32767;
              }
              return result.buffer;
            }
            function downsampleBuffer(buffer, sampleRate, outRate) {
              if (outRate === sampleRate) return buffer;
              const sampleRateRatio = sampleRate / outRate;
              const newLength = Math.round(buffer.length / sampleRateRatio);
              const result = new Float32Array(newLength);
              let offset = 0;
              for (let i = 0; i < newLength; i++) {
                const nextOffset = Math.round((i + 1) * sampleRateRatio);
                let sum = 0, count = 0;
                for (let j = offset; j < nextOffset && j < buffer.length; j++) {
                  sum += buffer[j];
                  count++;
                }
                result[i] = sum / count;
                offset = nextOffset;
              }
              return result;
            }
            registerProcessor('audio-processor', AudioProcessor);
          `], { type: "application/javascript" })));

          const source = audioContext.createMediaStreamSource(mediaStream);
          workletNode = new AudioWorkletNode(audioContext, 'audio-processor');

          workletNode.port.onmessage = (e) => {
            if (socket.readyState === WebSocket.OPEN) {
              const base64Audio = btoa(String.fromCharCode(...new Uint8Array(e.data)));
              socket.send(base64Audio);
              console.log("📤 Sent audio chunk (raw)");
            }
          };

          source.connect(workletNode);
          workletNode.connect(audioContext.destination);
        };

        socket.onclose = () => {
          console.warn("🛑 WebSocket closed");
          stopRecording();
        };
      } catch (e) {
        alert("Failed to start voice capture: " + e.message);
      }
    }

    function stopRecording() {
      if (socket?.readyState === WebSocket.OPEN) socket.close();
      if (audioContext?.state !== 'closed') audioContext.close();
      if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());
      transcribingIndicator.style.display = 'none';
      micScope.textContent = "🎤 Scope Visual";
      console.log("🛑 Recording stopped");
    }

    startVoiceButton.addEventListener("click", async () => {
      if (!isRecording) {
        isRecording = true;
        startVoiceButton.textContent = "⏹ Stop Voice";

        const unlocked = await unlockAudioContextAndMic();
        if (unlocked) await startRecording();
        else {
          isRecording = false;
          startVoiceButton.textContent = "🎙 Start Voice";
        }
      } else {
        isRecording = false;
        startVoiceButton.textContent = "🎙 Start Voice";
        stopRecording();
      }
    });

    document.getElementById("generateImage").addEventListener("click", async () => {
      const prompt = activityInput.value;
      const style = document.getElementById("styleSelect").value;
      if (!prompt) return alert("Describe your mood first.");
      const res = await fetch("https://mood-into-art-backend.onrender.com/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: `${style} style: ${prompt}` })
      });
      const { image } = await res.json();
      const canvas = document.getElementById("canvas1");
      const ctx = canvas.getContext("2d");
      const img = new Image();
      img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      img.src = image;
      document.getElementById("saveSound").play();
    });
  </script>
</body>
</html>
